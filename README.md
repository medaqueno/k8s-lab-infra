# Step-by-Step Installation Guide: Kubernetes Lab "From Scratch"

This guide covers setting up the management workstation and bootstrapping the cluster from zero using Talos Linux and OpenTofu.

## 1. Prerequisites (Management Machine)

You need a workstation (Mac or Linux) to manage the cluster. This machine is outside the cluster but has connectivity to the nodes.

### 1.1 Install Tools

#### MacOS
Using Homebrew:
```bash
# Core Tools
brew install opentofu kubectl talosctl istioctl argocd

# Verify
tofu version
talosctl version --client
```

#### Fedora (Linux)
```bash
# OpenTofu
sudo dnf install -y dnf-plugins-core
sudo dnf config-manager --add-repo https://packages.opentofu.org/opentofu/tofu/rpm/opentofu.repo
sudo dnf install -y tofu

# Kubectl
sudo dnf install -y kubernetes-client

# Istioctl, Talosctl, ArgoCD (Generic Binaries)
curl -sL https://talos.dev/install | sh
# Note: Manually move binaries to /usr/local/bin or your PATH
```

#### Debian/Ubuntu (Linux)
```bash
# OpenTofu
curl -fsSL https://get.opentofu.org/opentofu.gpg | sudo tee /etc/apt/keyrings/opentofu.gpg
echo "deb [signed-by=/etc/apt/keyrings/opentofu.gpg] https://packages.opentofu.org/opentofu/opentofu/any/ any main" | sudo tee /etc/apt/sources.list.d/opentofu.list
sudo apt-get update && sudo apt-get install -y tofu

# Kubectl & others similar to Fedora/Generic scripts
```

## 2. Cluster Architecture & Design

Before deploying, review the **[Architecture Overview](architecture_overview.md)** to understand the tiering (Platform vs Applications) and the Istio Ambient Mesh traffic flow.

## 3. Bootstrapping the Infrastructure

We use **OpenTofu** for all provider and machine configuration.

1.  Navigate to the cluster directory:
    ```bash
    cd clusters/main-cluster
    ```
2.  Initialize and Plan:
    ```bash
    tofu init
    tofu plan
    ```
3.  **Generate Blueprints**:
    ```bash
    tofu apply
    ```

### 3.1 Provisioning the Nodes (OS Level)
Now that OpenTofu has generated your YAML blueprints, you must apply them to the physical nodes.

#### A. Apply Configuration to the first node
Sends the generated YAML to the node (replace with your node IP).
```bash
talosctl apply-config --insecure --nodes 192.168.1.35 --file _generated/controlplane.yaml
```

#### B. Initialize the Cluster (Etcd)
```bash
# Set your talosconfig (generated by OpenTofu)
export TALOSCONFIG=$(pwd)/_generated/talosconfig

# Initialize the first node
talosctl bootstrap --nodes 192.168.1.35
```

If you prefer to avoid the environment variable, you can run:
```bash
talosctl bootstrap --nodes 192.168.1.35 --talosconfig _generated/talosconfig
```

#### C. Retrieve Kubeconfig
```bash
talosctl kubeconfig _generated/ --nodes 192.168.1.35 --talosconfig _generated/talosconfig
```

#### D. Verify Cluster Health
```bash
talosctl health --nodes 192.168.1.35 --talosconfig _generated/talosconfig
```

## 4. Post-Install: Platform Setup (ArgoCD & Istio)

Once the cluster is up, follow the GitOps bootstrap process:

1.  **ArgoCD Bootstrapping**:
    Instalar ArgoCD en el namespace `platform-tools` y parchear los Deployments para que se ejecuten en el tier `platform`.
    ```bash
    kubectl create namespace platform-tools
    kubectl apply -n platform-tools -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
    ```

2.  **Istio Ambient Installation**:
    ```bash
    istioctl install --set profile=ambient --namespace platform-tools -y
    ```

For detailed platform configuration (Gateways, HTTPRoutes), refer to the manifests in the **k8s-lab-gitops** repository.
